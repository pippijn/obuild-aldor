\clearpage
\section{Connecting to the characteristic set library from within Mathematica}
\defsec{casmathematica}

This section illustrates how the exported code of \refsec{preparationsinaldor} can be connected to \Mathematica.

The first part of this section analyzes \Mathematica and \MathLink, the framework to connect code to \Mathematica. The second part discusses how \MathLink enabled executables are generated. This second part heavily relies on template files which are described in depth in the last part of this section.

\subsection{A closer look at Mathematica}

Before connecting \exportedsymbol to \Mathematica, it is important to investigate \Mathematica closer and identify its sub-parts. Afterwards a sub-part to connect \exportedsymbol to is identified and the used technology is presented.

The computer algebra system \Mathematica\cite{Mathematica} provides two main components, which are 
\begin{itemize}
\item the notebook interface and 
\item the kernel.
\end{itemize}
While the notebook interface is typically used to input expressions and receive output, all computations are performed by the kernel. This splitting up is not artificial, but can be seen already in the file system. The executable \file{math} represents \Mathematica's kernel, \file{mathematica} represents \Mathematica's notebook interface. These two programs are independent from each other. The notebook interface can be used without the kernel and vice versa. However, the notebook interface has to be connected to a kernel for performing computations\footnote{On evaluating the first cell within a notebook, the notebook interface typically starts a kernel locally. The user is given no feedback about this, except that evaluating the first cell takes considerably longer than subsequent evaluation of cells. This delay is due to starting a local kernel. It is not necessary to start a local kernel. The notebook interface also allows to use kernels running on other computers.}. As the computational engine of \Mathematica is its kernel, \exportedsymbol has to be connected to the kernel. \Mathematica provides an interface to its kernel via \MathLink. \MathLink\cite{MathLink} is \Mathematica's standard to pass data between applications. For example, the connection between the notebook interface and a kernel is made through \MathLink.

The rest of \refsec{casmathematica} discusses how \exportedsymbol is connected to \Mathematica's kernel via \MathLink.

It is important to see that \MathLink is not a further program, but simply a name for the specification of how to represent and transmit data. \Mathematica's kernel does not allow to import libraries. It can only import code via \MathLink.

\MathLink is \Mathematica's proposed way to connect foreign code to the \Mathematica kernel. Foreign code has to implement the \MathLink functionality to be able to connect to the kernel via \MathLink. For common languages like \C, or \Java software development kits are provided. These kits can be used to built \MathLink enabled programs.

As \exportedsymbol follows \C calling conventions, the \C software development kit is used for this discussion. Although this kit is shipped with \Mathematica, it can be obtained independently from \Mathematica at \cite{MathLinkSDK}.

For this treatment, \MathLink's \C software development kit that is shipped with \Mathematica $5.1$ is used. This version's documentation of the contained \Mcc script does not match the \Mcc script itself. This fact also holds for the other versions of the software development kit that are available to the author. These are those of \Mathematica $3.0.2$, \Mathematica $4.0$, \Mathematica $4.1$, \Mathematica $4.2$, \Mathematica $5.0$, and the kit from \cite{MathLinkSDK} on $15^{th}$ October $2005$. However, the version from \Mathematica $5.1$ is chosen.

The main parts of the \C software development kit for \Mathematica are
\begin{itemize}
\item \Mcc,
\item \Mprep,
\item \file{mathlink.h}, and
\item \file{libML.a}.
\end{itemize}

\Mcc is a script automating compilation of \MathLink template files to \MathLink enabled executables. \MathLink template files are treated separately in \refsec{mathlink}.

\Mprep is a preprocessor converting \MathLink templates to \C files.

\file{mathlink.h} is a \C header source file. This file is needed to compile the \C files generated by \Mprep.

\file{libML.a} is a library implementing the definitions of \file{mathlink.h}. This file is needed to link object files to executables.

We investigate \Mcc further, as it hides the use of the other three parts from the user. With the help of \Mcc, a \MathLink enabled executable is built that can easily be connected to the \Mathematica kernel.

\subsection{MathLink's Mcc compiler script and MathLink enabled executables}
\defsec{mcc}

This section focuses on \Mcc and its use to compile \Aldor's exported \C code to \MathLink enabled executables. Additionally, at the end of this section it is shown how to connect \MathLink enabled executables to \Mathematica.

\Mcc is a wrapper for the \C compiler and converts \MathLink template files to \MathLink enabled executable files. \MathLink template files specify how and which \C functions are to be made accessible through \MathLink. These template files are discussed in detail in \refsec{mathlink}.

Internally, the \Mcc script operates in two stages. The first stage passes the \MathLink template files to \Mprep. \Mprep is a preprocessor that converts \MathLink templates to a single \C file. This \C file depends on \file{mathlink.h}. In the second stage of \Mcc, the generated \C file from \Mprep is compiled and linked against the library \file{libML.a}. The work-flow for \Mcc is depicted in \reffig{mccmprep}.

\diagrameps[7cm]{mccmprep}{The internals of \Mcc}

In the further discussion, command line options to the \Mcc script are presented. These command line options refer to the script itself. These options' implementation sometimes does not match their documentation. Other options are completely undocumented. However, as mentioned above, the documentation of \Mcc that is shipped with the used software development kit is not accurate. Therefore, the documentation is ignored and the script itself is analyzed. Furthermore, \Mcc relies on a \C compiler. As \Mcc passes several options directly to the \C compiler, it is important to use a compatible \C compiler. It is assumed, that \Gcc is used as \C compiler for \Mcc{}\footnote{\Mcc tries to use the \C compiler specified by the environment variable \environmentvariable{CC}. If \environmentvariable{CC} is empty, \Mcc falls back to using \file{cc}. On most \GNULinux systems, \environmentvariable{CC} is empty and \file{cc} refers to \Gcc. Therefore, on most \GNULinux systems, \Mcc defaults to using \Gcc.}. Additionally, let \commandline{MLINCDIR} denote the directory of \file{mathlink.h} and \commandline{MLLIBDIR} the directory of \file{libML.a}. Typically both directories refer to the \file{AddOns/MathLink/DeveloperKit/Linux/CompilerAdditions} sub-directory of \Mathematica. 

When adapting \C code for the use with \MathLink, it usually suffices to incorporate the implemented \C code into a template file. Assuming this template file is called \file{sometemplate.tm}, a call to

\commandline{mcc sometemplate.tm}

compiles it to a \MathLink executable. This executable is called \file{a.out}. \Mcc's command line option \commandlineparameter{-o} can be used to override the output file.

\commandline{mcc -o someexecutable sometemplate.tm}

compiles \file{sometemplate.tm} to the executable \file{someexecutable}. Such a call however does not work for the \file{charset.tm} \MathLink template file of \refsec{mathlink}. That \MathLink template has to be linked with the implementation of \exportedsymbol. This implementation can be found in the \LibCharSet library. Therefore, \Mcc has to instruct the underlying compiler to link against the \LibCharSet library\footnote{When compiling to an executable, it does not suffice, to link against \LibCharSet, as \LibCharSet again has unresolved symbols. These symbols are resolved in \LibExtIO, \LibAlgebra, \LibAldor. These libraries again have unresolved symbols. In the end, the \MathLink file has to be linked against the libraries \LibCharSet, \LibExtIO, \LibAlgebra, \LibAldor, \LibFoam, and \LibM. Specifying all these libraries for every upcoming command line renders the given commands unreadable. Therefore, only the first of these libraries is given, as the \LibCharSet library suffices to illustrate the problems.}. The necessary option for this linkage is \commandlineparameter{-lcharset}. However, when calling \Mcc by

\commandline{mcc -o charset charset.tm -lcharset}

\Mcc invokes the \C compiler with

\begin{verbatim}
gcc -o charset -I MLINCDIR -lcharset charset.tm.c \
  -L MLLIBDIR -lML -lm
\end{verbatim}

while the correct call would be 

\begin{verbatim}
gcc -o charset -I MLINCDIR charset.tm.c -lcharset \
  -L MLLIBDIR -lML -lm
\end{verbatim}

It is however crucial that \commandlineparameter{charset.tm.c} comes \emph{before} \commandlineparameter{-lcharset}. Otherwise, the compiled \file{charset.tm.c} is not linked against the \LibCharSet library\footnote{This behaviour of \Gcc is not a bug. \Gcc resolves the symbols of object files from left to right. Therefore, only the object files of \file{libML.a} and \file{libm.a} are used to resolve the symbols of \file{charset.tm.c}'s object file when using \Mcc. \Ld, which is used by \Gcc for linking, can be set up to use groups of libraries. This grouping of libraries allows to pass \file{charset.tm.c} after \file{-lcharset} and still have all symbols resolved. For example\\
\commandline{gcc -o charset -I MLINCDIR -Xlinker --start-group charset.tm.c -lcharset $\backslash$}\\
\hspace{2cm}\commandline{-Xlinker --end-group -L MLLIBDIR -lML -lm}\\
groups \LibCharSet and the object file of \file{charset.tm.c}. Although this call to \Gcc works and the call states \commandline{-lcharset} after \file{charset.tm.c}, it cannot be used to solve the \Mcc issues. With this solution \commandline{-lcharset} can be specified after \file{charset.tm.c}. However, \commandline{-Xlinker --start-group} has to occur \emph{before} \file{charset.tm.c}. Therefore, an equivalent problems arise, as\\
\commandline{mcc -o charset -Xlinker --start-group charset.tm -lcharset -Xlinker  $\backslash$}\\
$\quad$\hspace{2cm}\commandline{ --end-group}\\
resolves to\\
\commandline{gcc -o charset -I MLINCDIR -Xlinker --start-group -lcharset $\backslash$}\\
\hspace{2cm}\commandline{-Xlinker --end-group charset.tm.c -L MLLIBDIR -lML -lm}}.

The possible workarounds are
\begin{itemize}
\item to call \Mprep and \Gcc manually,
\item to use \Mcc only to compile the file and link the file manually later on, or
\item to extract and modify the call to the \C compiler.
\end{itemize}

Calling \Mprep and \Gcc manually overcomes the need for \Mcc. The commands
\begin{verbatim}
mprep -o charset.tm.c charset.tm
gcc -o charset -I MLINCDIR charset.tm.c -lcharset \
  -L MLLIBDIR -lML -lm
\end{verbatim}
compile the \file{charset.tm} template to the \C file \file{charset.tm.c}, which is in turn compiled to the executable \file{charset}. This solution is the most flexible of the three workarounds. Every command can be called with exactly those options that are required. The major disadvantage of this workaround is that it does not use \Mcc at all. However, \Mcc is the \MathLink's proposed way to compile \MathLink enabled executables. Therefore, future versions of \MathLink will focus on keeping the use of \Mcc consistent. The use of \Mprep is subject to changes. As a result, it can be expected that the presented use of \Mprep is obsolete in further versions of the \MathLink \C software development kit. Furthermore, the corresponding \commandline{MLINCDIR} and \commandline{MLLIBDIR} have to be determined manually. When using \Mcc to build the executable, \Mcc locates the proper directories on its own.

The second workaround is to use \Mcc only to compile the file and link manually. The first line of the command sequence
\begin{verbatim}
mcc -c charset.tm
gcc -o charset charset.tm.o -lcharset -L MLLIBDIR -lML -lm
\end{verbatim}
uses \Mcc to compile the template \file{charset.tm} to the object file \file{charset.tm.o}. The command line option \commandlineparameter{-c} tells \Mcc to use \Mprep to generate the \C file \file{charset.tm.c} and finally use the \C compiler to compile the \C file to the object file \file{charset.tm.o}. In the second line, this object file is linked to an executable by \Gcc. It is also possible to use \Ld, the GNU Linker, for linking the object file. However, using \Ld requires to pass further options and link against further libraries. When using \Gcc, these issues are hidden from the user. 

The presented workaround does no longer invoke \Mprep explicitly and does not require to pass the directory \file{MLINCDIR} to any command. However, \file{MLLIBDIR} is still required. Furthermore, future versions of \MathLink may come with additional or other libraries and may require to link against some of these libraries. As a result, the call to gcc has to be adjusted. Therefore, the presented workaround is again likely to fail for future versions of \MathLink's \C software development kit.

The last workaround is to extract and modify the call to the \C compiler. The commands
\begin{verbatim}
export OLDCC=$CC 
if [ -z "$OLDCC" ] ; then export OLDCC=cc ; fi
export CC=echo
$OLDCC `mcc -g -o charset charset.tm` -lcharset
export CC=$OLDCC
\end{verbatim}
can be used in any \Bash-like shell. The first three lines are used to store the system's \C compiler in the environment variable \environmentvariable{OLDCC} and set the environment variable \environmentvariable{CC} to the \commandline{echo} command. As \Mcc uses \environmentvariable{CC} as \C compiler, \Mcc's calls to the \C compiler (see line $4$) are echoed. The command \commandline{`mcc -g -o charset charset.tm`} evaluates to 
\begin{verbatim}
-o charset.mathlink -I MLINCDIR -g charset.tm.c -L MLLIBDIR -lML -lm
\end{verbatim}
which are the arguments to the \C compiler to compile to an executable. The forth line of this workaround prepends the \C compilers executable and appends the \commandlineparameter{-lcharset} to link against the \LibCharSet library. Thereby, the \C compiler is invoked with the proper options and the appended \commandlineparameter{-lcharset}. The last line of the workaround resets the environment variable \environmentvariable{CC}.

This workaround passes the command line parameter \commandlineparameter{-g} to \Mcc. 
After compilation, \Mcc typically removes the generated \C and object files. For this workaround, it is essential that \Mcc does \emph{not} remove the generated \C file, as this file is needed for the \C compiler. Therefore, \Mcc is called with the parameter \commandlineparameter{-g}. This parameter tells \Mcc to not remove the generated \C file. Additionally, \Mcc passes the \commandlineparameter{-g} to the \C compiler. \C compilers generate debugging information when passed the \commandline{-g} option.

This workaround is the most complex of the three presented alternatives. However, it does not require to specify \commandlineparameter{MLLIBDIR} or \commandlineparameter{MLINCDIR}. Therefore, it is the only workaround that works without further knowledge of the used system. Additionally, it is the only workaround that can be expected to work in future versions of \MathLink, as it does not call \Mprep directly and makes no assumption on which libraries to use. Therefore, the third workaround is proposed among the three presented ones.

%With each of the three presented workarounds a \MathLink enabled executable \file{charset} can be generated from the \MathLink template of \refsec{extendedmathlink}. To use this executable from within \Mathematica it suffices to call
Each of the three presented workarounds can be used to generate a \MathLink enabled executable \file{charset} the \MathLink template of \refsec{extendedmathlink}. To use this executable from within \Mathematica it suffices to call

\begin{mathematicaprogram}
Install["/path/to/charset"]
\end{mathematicaprogram}

in either the notebook interface or the kernel itself, where \file{/path/to} denotes the directory of \file{charset}. \mathematicacode{Install} starts the \file{charset} executable and connects the kernel to it. Afterwards the function \mathematicacode{CoherentAutoreducedSet} of \file{charset} can be used. There is no need to explicitly bring the package \mathematicacode{CharacteristicSet} into scope.

%\MathLink also allows the generated executable to run on a different computer as the \Mathematica kernel. This does not require any modifications of \file{charset}, \MathLink also allows 

%The \mathematicacode{Install} command starts the program on the computer on which the kernel is running. However, it is possible to execute the kernel and the \file{charset} \MathLink executable on different computers. In such a setting, it is necessary to start the \MathLink executable manually on a computer with the \commandlineparameter{-linkcreate}. If this is successful, the executableThere the executable gives prompts for a link. 



%\begin{mathematicaprogram}
%Mathematica 5.1 for Linux
%Copyright 1988-2004 Wolfram Research, Inc.
% -- Motif graphics initialized -- 
%
%In[1]:= Install["charset.mathlink"]
%
%Out[1]= LinkObject[./charset.mathlink, 1, 1]
%
%In[2]:= depvars := { y1, y2, y3 }
%
%In[3]:= indepvars := { s, t }
%
%In[4]:= poly1 := D[y2[s,t],t]*y3[s,t]
%
%In[5]:= poly2 := D[y1[s,t],s]
%
%In[6]:= poly3 := y2[s,t]
%
%In[7]:= polys := { poly1, poly2, poly3 }
%
%In[8]:= domOptions := ""
%
%In[9]:= CoherentAutoreducedSet[ polys, depvars, indepvars, domOptions ]
%
%                     (1,0)
%Out[9]= {y2[s, t], y1     [s, t]}
%\end{mathematicaprogram}

\input{cas-mathematica-tm}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Local Variables: 
%%% ispell-local-dictionary: "english"
%%% End:
